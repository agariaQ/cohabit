<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quarkus Auth Test</title>
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; max-width: 700px; margin: 2rem auto; padding: 1rem; background-color: #f8f9fa; color: #333; }
        h1 { color: #2c3e50; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        section { background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 2rem; }
        h2 { margin-top: 0; color: #2c3e50; }
        form { display: grid; gap: 10px; }
        input, select { width: 100%; padding: 10px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        button { padding: 10px 15px; cursor: pointer; background-color: #3498db; color: white; border: none; border-radius: 4px; font-weight: bold; }
        button:hover { background-color: #2980b9; }
        button#check-btn { background-color: #27ae60; }
        button#check-btn:hover { background-color: #219150; }
        pre { background: #2c3e50; color: #ecf0f1; padding: 1rem; overflow-x: auto; border-radius: 4px; min-height: 50px; }
        .label { font-weight: bold; margin-bottom: 2px; display: block; font-size: 0.9em; }
        .row { display: flex; gap: 10px; }
    </style>
</head>
<body>

<h1>Cohabit Backend Test</h1>

<section>
    <h2>1. Registrieren</h2>
    <form id="register-form">
        <label class="label">Benutzerdaten</label>
        <div class="row">
            <select id="reg-role">
                <option value="USER">üë§ Mieter (USER)</option>
                <option value="VENDOR">üè† Vermieter (VENDOR)</option>
            </select>
            <input type="email" id="reg-email" placeholder="Email Adresse" required />
        </div>
        <input type="password" id="reg-password" placeholder="Passwort" required />

        <label class="label">Adresse (Optional)</label>
        <input type="text" id="reg-street" placeholder="Stra√üe & Hausnr." />
        <div class="row">
            <input type="text" id="reg-postal" placeholder="PLZ" style="flex:1" />
            <input type="text" id="reg-city" placeholder="Stadt" style="flex:2" />
        </div>
        <input type="text" id="reg-country" placeholder="Land" value="√ñsterreich" />

        <button type="submit">Account erstellen</button>
    </form>
    <pre id="register-result">Warte auf Eingabe...</pre>
</section>

<section>
    <h2>2. Login</h2>
    <form id="login-form">
        <input type="email" id="login-email" placeholder="Email" required />
        <input type="password" id="login-password" placeholder="Passwort" required />
        <button type="submit">Einloggen & Token holen</button>
    </form>
    <pre id="login-result">Noch nicht eingeloggt.</pre>
</section>

<section>
    <h2>3. Token pr√ºfen (/api/v1/users/me)</h2>
    <p>Klicke hier, um zu pr√ºfen, ob der eingeloggte User wirklich die Rolle <b>VENDOR</b> hat.</p>
    <button id="check-btn">Meine Daten laden</button>
    <pre id="me-result">Keine Daten geladen.</pre>
</section>

<script>
    const API_BASE = 'http://localhost:8080/api/v1';
    let currentToken = null;

    function pretty(obj) {
        try { return JSON.stringify(obj, null, 2); } catch (e) { return obj; }
    }

    async function parseResponse(res) {
        const text = await res.text();
        try {
            return {
                ok: res.ok,
                status: res.status,
                data: text ? JSON.parse(text) : {}
            };
        } catch (e) {
            return {
                ok: false,
                status: res.status,
                error: "Kein g√ºltiges JSON erhalten. Server Antwort:",
                raw: text
            };
        }
    }

    document.getElementById('register-form').addEventListener('submit', async e => {
        e.preventDefault();

        const payload = {
            email:   document.getElementById('reg-email').value,
            password:document.getElementById('reg-password').value,
            requestedRole: document.getElementById('reg-role').value,
            address: {
                street:    document.getElementById('reg-street').value,
                city:      document.getElementById('reg-city').value,
                postalCode:document.getElementById('reg-postal').value,
                country:   document.getElementById('reg-country').value
            }
        };

        try {
            const res = await fetch(`${API_BASE}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await parseResponse(res);

            if (result.raw) {
                document.getElementById('register-result').textContent =
                    `Status: ${result.status}\n${result.error}\n\n${result.raw.substring(0, 500)}...`;
            } else {
                document.getElementById('register-result').textContent = pretty(result.data);
            }

            if(result.ok) {
                document.getElementById('login-email').value = payload.email;
                document.getElementById('login-password').value = payload.password;
            }

        } catch (err) {
            document.getElementById('register-result').textContent = 'Netzwerk-Fehler: ' + err;
        }
    });

    document.getElementById('login-form').addEventListener('submit', async e => {
        e.preventDefault();
        const creds = {
            email:   document.getElementById('login-email').value,
            password:document.getElementById('login-password').value
        };

        try {
            const res = await fetch(`${API_BASE}/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(creds)
            });

            const result = await parseResponse(res);

            if (result.raw) {
                document.getElementById('login-result').textContent = `Server Fehler:\n${result.raw}`;
            } else {
                document.getElementById('login-result').textContent = pretty(result.data);

                if (result.ok && result.data.token) {
                    currentToken = result.data.token;
                    alert("Login erfolgreich! Token gespeichert.");
                }
            }
        } catch (err) {
            document.getElementById('login-result').textContent = 'Netzwerk-Fehler: ' + err;
        }
    });

    document.getElementById('check-btn').addEventListener('click', async () => {
        if (!currentToken) {
            alert("Bitte erst einloggen!");
            return;
        }

        try {
            const res = await fetch(`${API_BASE}/users/me`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + currentToken
                }
            });

            const result = await parseResponse(res);
            document.getElementById('me-result').textContent = pretty(result.data || result.raw);

            if(result.data && result.data.roles && result.data.roles.includes('VENDOR')) {
                document.getElementById('me-result').style.border = "4px solid green";
            } else {
                document.getElementById('me-result').style.border = "4px solid red";
            }

        } catch (err) {
            document.getElementById('me-result').textContent = 'Netzwerk-Fehler: ' + err;
        }
    });
</script>
</body>
</html>